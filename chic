#!/bin/bash -eu

. $(dirname $0)/lib/args.sh

base_dir="${1:-}"
if [ -z "$base_dir" ]; then
	usage
	exit 1
fi

if [ -d "$base_dir" ]; then
	chicfile="$base_dir/Chicfile"
	if [ ! -f "$chicfile" ]; then
		echo "Chicfile not found in $base_dir" >&2
		exit 1
	fi
elif [ -f "$base_dir" ]; then
	chicfile="$base_dir"
	base_dir="$(dirname $base_dir)"
else
	echo "Base dir is not a directory: $base_dir" >&2
	exit 1
fi

date_stamp=$(date +%Y%m%d%H%M%S)

. "$(dirname $0)"/lib/stacks.sh
. "$(dirname $0)"/lib/build.sh
. "$(dirname $0)"/lib/termination.sh
. "$(dirname $0)"/lib/aws-setup.sh
. "$(dirname $0)"/lib/chicfile.sh
. "$(dirname $0)"/lib/image.sh

# Run Chicfile
echo "* Running Chicfile: $chicfile" >&2

pushd "$base_dir" >/dev/null
. "$(basename $chicfile)"
popd

# Build image
buildImage

terminate

echo "$new_ami_id"
