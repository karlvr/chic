#!/bin/bash -eu

. $(dirname $0)/lib/args.sh

base_dir="${1:-}"
if [ -z "$base_dir" ]; then
	usage
	exit 1
fi

chicfile="$base_dir/Chicfile"
if [ ! -f "$chicfile" ]; then
	echo "Chicfile not found in $base_dir" >&2
	exit 1
fi

date_stamp=$(date +%Y%m%d%H%M%S)

. "$(dirname $0)"/lib/stacks.sh
. "$(dirname $0)"/lib/build.sh
. "$(dirname $0)"/lib/termination.sh
. "$(dirname $0)"/lib/aws-setup.sh
. "$(dirname $0)"/lib/chicfile.sh
. "$(dirname $0)"/lib/image.sh

# Run Chicfile
echo "* Running Chicfile" >&2
. "$chicfile"

# Build image
buildImage

terminate

echo "$new_ami_id"
